name: CI/CD Pipeline - Infra Mind

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '20'
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  # ==================== BACKEND TESTS ====================
  backend-tests:
    name: Backend Tests & Quality
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_ROOT_USERNAME: admin
          MONGO_INITDB_ROOT_PASSWORD: password
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand({ ping: 1 })'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio pytest-mock
          pip install bandit safety mypy

      - name: Run unit tests
        env:
          INFRA_MIND_MONGODB_URL: mongodb://admin:password@localhost:27017/infra_mind_test?authSource=admin
          INFRA_MIND_REDIS_URL: redis://localhost:6379
          INFRA_MIND_ENVIRONMENT: testing
        run: |
          pytest tests/ \
            --cov=src/infra_mind \
            --cov-report=xml \
            --cov-report=html \
            --cov-report=term-missing \
            --junitxml=pytest-report.xml \
            -v

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage.xml
          flags: backend
          name: backend-coverage

      - name: Security scan with Bandit
        run: |
          bandit -r src/ -f json -o bandit-report.json || true
          bandit -r src/ -f txt

      - name: Dependency security check with Safety
        run: |
          safety check --json --output safety-report.json || true
          safety check

      - name: Type checking with mypy
        run: |
          mypy src/infra_mind --ignore-missing-imports --show-error-codes || true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-results
          path: |
            pytest-report.xml
            htmlcov/
            bandit-report.json
            safety-report.json

  # ==================== FRONTEND TESTS ====================
  frontend-tests:
    name: Frontend Tests & Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend-react/package-lock.json

      - name: Install dependencies
        working-directory: ./frontend-react
        run: npm ci

      - name: Run linting
        working-directory: ./frontend-react
        run: npm run lint

      - name: Run type checking
        working-directory: ./frontend-react
        run: npm run type-check

      - name: Run unit tests
        working-directory: ./frontend-react
        run: npm run test:ci

      - name: Build frontend
        working-directory: ./frontend-react
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000
        run: npm run build

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-test-results
          path: |
            frontend-react/coverage/
            frontend-react/.next/

  # ==================== DOCKER BUILD ====================
  docker-build:
    name: Docker Build & Test
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images
        run: |
          docker-compose build --no-cache

      - name: Start services
        run: |
          docker-compose up -d
          sleep 30  # Wait for services to be ready

      - name: Health check - Backend
        run: |
          for i in {1..10}; do
            if curl -f http://localhost:8000/health; then
              echo "✅ Backend health check passed"
              exit 0
            fi
            echo "Waiting for backend... attempt $i/10"
            sleep 5
          done
          echo "❌ Backend health check failed"
          docker-compose logs api
          exit 1

      - name: Health check - Frontend
        run: |
          for i in {1..10}; do
            if curl -f http://localhost:3000; then
              echo "✅ Frontend health check passed"
              exit 0
            fi
            echo "Waiting for frontend... attempt $i/10"
            sleep 5
          done
          echo "❌ Frontend health check failed"
          docker-compose logs frontend
          exit 1

      - name: Run integration tests
        run: |
          # Wait for all services
          sleep 10

          # Test API endpoints
          curl -f http://localhost:8000/api/assessments || exit 1

          # Test WebSocket
          curl -f http://localhost:8000/ws || true

      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== API Logs ==="
          docker-compose logs api
          echo "=== Frontend Logs ==="
          docker-compose logs frontend
          echo "=== MongoDB Logs ==="
          docker-compose logs mongodb
          echo "=== Redis Logs ==="
          docker-compose logs redis

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # ==================== CODE QUALITY ====================
  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Run CodeQL Analysis
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      - name: SonarCloud Scan
        if: false  # Enable when SonarCloud is configured
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ==================== SECURITY SCAN ====================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'

      - name: OWASP Dependency Check
        if: false  # Enable for production
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'infra-mind'
          path: '.'
          format: 'HTML'

  # ==================== PERFORMANCE TESTS ====================
  performance-tests:
    name: Performance & Load Testing
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start services
        run: |
          docker-compose up -d
          sleep 30

      - name: Install k6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Run load tests
        run: |
          # Create load test script
          cat > load-test.js << 'EOF'
          import http from 'k6/http';
          import { check, sleep } from 'k6';

          export const options = {
            stages: [
              { duration: '30s', target: 20 },
              { duration: '1m', target: 50 },
              { duration: '30s', target: 0 },
            ],
            thresholds: {
              http_req_duration: ['p(95)<500'],
              http_req_failed: ['rate<0.01'],
            },
          };

          export default function () {
            const res = http.get('http://localhost:8000/health');
            check(res, {
              'status is 200': (r) => r.status === 200,
              'response time < 500ms': (r) => r.timings.duration < 500,
            });
            sleep(1);
          }
          EOF

          k6 run load-test.js

      - name: Cleanup
        if: always()
        run: docker-compose down -v

  # ==================== DEPLOY TO STAGING ====================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build, code-quality, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.inframind.ai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        if: false  # Enable when AWS is configured
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Login to Docker registry
        if: false  # Enable when registry is configured
        run: |
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

      - name: Build and push Docker images
        if: false  # Enable when registry is configured
        run: |
          docker-compose -f docker-compose.production.yml build
          docker-compose -f docker-compose.production.yml push

      - name: Deploy to staging
        if: false  # Enable when deployment is configured
        run: |
          # Deploy to staging environment
          # This could use kubectl, terraform, ansible, etc.
          echo "Deploying to staging..."

  # ==================== DEPLOY TO PRODUCTION ====================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker-build, code-quality, security-scan]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://inframind.ai

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ github.run_number }}
          release_name: Release v${{ github.run_number }}
          draft: false
          prerelease: false

      - name: Deploy to production
        if: false  # Enable when ready for production
        run: |
          echo "Production deployment would happen here"
          # Deployment steps...

  # ==================== NOTIFICATION ====================
  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [backend-tests, frontend-tests, docker-build]
    if: always()

    steps:
      - name: Send Slack notification
        if: false  # Enable when Slack is configured
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'CI/CD Pipeline completed'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}

      - name: Summary
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "✅ Backend tests: ${{ needs.backend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Frontend tests: ${{ needs.frontend-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Docker build: ${{ needs.docker-build.result }}" >> $GITHUB_STEP_SUMMARY
