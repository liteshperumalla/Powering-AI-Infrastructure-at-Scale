<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Chat API Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .test-section h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px 4px;
            font-size: 14px;
            font-weight: 500;
            transition: transform 0.2s;
        }
        button:hover {
            transform: translateY(-2px);
        }
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #007bff;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            border-left-color: #28a745;
            background: #d4edda;
            color: #155724;
        }
        .warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        .response {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-pending { background-color: #ffc107; }
        .websocket-test {
            border: 2px solid #17a2b8;
            background: #e7f3ff;
        }
        .llm-test {
            border: 2px solid #6f42c1;
            background: #f3e7ff;
        }
        .summary {
            background: #e9ecef;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî¨ Comprehensive Chat System Diagnostics</h1>
        <p>This tool will test all aspects of your AI Assistant Chat system including API endpoints, WebSockets, LLM integration, and validation.</p>
    </div>

    <div class="test-grid">
        <!-- Basic API Tests -->
        <div class="test-section">
            <h3>üåê Basic API Connectivity</h3>
            <button onclick="testAPIHealth()">Test API Health</button>
            <button onclick="testCorsPolicy()">Test CORS Policy</button>
            <button onclick="testAPIVersions()">Test API Versions</button>
            <div id="basic-api-results"></div>
        </div>

        <!-- Chat Endpoints Tests -->
        <div class="test-section">
            <h3>üí¨ Chat API Endpoints</h3>
            <button onclick="testSimpleChatV1()">Test Simple Chat (v1)</button>
            <button onclick="testSimpleChatDirect()">Test Simple Chat (direct)</button>
            <button onclick="testChatHealthEndpoint()">Test Chat Health</button>
            <button onclick="testAuthenticatedChat()">Test Auth Chat</button>
            <div id="chat-api-results"></div>
        </div>

        <!-- WebSocket Tests -->
        <div class="test-section websocket-test">
            <h3>üîå WebSocket Connectivity</h3>
            <button onclick="testWebSocketConnection()">Test WebSocket Connect</button>
            <button onclick="testWebSocketHeartbeat()">Test Heartbeat</button>
            <button onclick="disconnectWebSocket()">Disconnect WebSocket</button>
            <div id="websocket-results"></div>
        </div>

        <!-- LLM Integration Tests -->
        <div class="test-section llm-test">
            <h3>ü§ñ LLM Integration</h3>
            <button onclick="testLLMSimpleQuery()">Test Simple LLM Query</button>
            <button onclick="testLLMComplexQuery()">Test Complex Query</button>
            <button onclick="testLLMErrorHandling()">Test Error Handling</button>
            <div id="llm-results"></div>
        </div>

        <!-- Frontend Integration -->
        <div class="test-section">
            <h3>‚öõÔ∏è Frontend Integration</h3>
            <button onclick="testFrontendAPIAccess()">Test Frontend API</button>
            <button onclick="testAuthToken()">Test Auth Token</button>
            <button onclick="simulateFrontendChat()">Simulate Frontend Chat</button>
            <div id="frontend-results"></div>
        </div>

        <!-- System Status -->
        <div class="test-section">
            <h3>üìä System Status</h3>
            <button onclick="getSystemMetrics()">Get System Metrics</button>
            <button onclick="checkDockerServices()">Check Docker Services</button>
            <button onclick="runFullDiagnostic()">Run Full Diagnostic</button>
            <div id="system-results"></div>
        </div>
    </div>

    <div class="summary" id="test-summary" style="display: none;">
        <h2>üìã Test Summary</h2>
        <div id="summary-content"></div>
    </div>

    <script>
        let testResults = {};
        let websocket = null;

        function addResult(sectionId, title, content, type = 'info') {
            const section = document.getElementById(sectionId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            
            const statusIcon = document.createElement('span');
            statusIcon.className = `status-indicator status-${type === 'error' ? 'error' : type === 'success' ? 'success' : 'pending'}`;
            
            resultDiv.innerHTML = `
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    ${statusIcon.outerHTML}
                    <strong>${title}</strong>
                    <span style="margin-left: auto; font-size: 11px; opacity: 0.7;">${new Date().toLocaleTimeString()}</span>
                </div>
                <div class="response">${content}</div>
            `;
            
            section.appendChild(resultDiv);
            testResults[title] = { type, content, timestamp: new Date() };
            updateSummary();
        }

        function updateSummary() {
            const summary = document.getElementById('test-summary');
            const summaryContent = document.getElementById('summary-content');
            
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r.type === 'success').length;
            const failed = Object.values(testResults).filter(r => r.type === 'error').length;
            const pending = total - passed - failed;
            
            summaryContent.innerHTML = `
                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                    <div><strong>Total Tests:</strong> ${total}</div>
                    <div style="color: #28a745;"><strong>Passed:</strong> ${passed}</div>
                    <div style="color: #dc3545;"><strong>Failed:</strong> ${failed}</div>
                    <div style="color: #ffc107;"><strong>Other:</strong> ${pending}</div>
                </div>
            `;
            
            if (total > 0) {
                summary.style.display = 'block';
            }
        }

        // Basic API Tests
        async function testAPIHealth() {
            try {
                const response = await fetch('http://localhost:8000/health');
                const data = await response.json();
                addResult('basic-api-results', 'API Health Check', JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                addResult('basic-api-results', 'API Health Check', `Error: ${error.message}`, 'error');
            }
        }

        async function testCorsPolicy() {
            try {
                const response = await fetch('http://localhost:8000/api/chat/simple', {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': 'http://localhost:3000',
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                addResult('basic-api-results', 'CORS Policy Check', 
                    `Status: ${response.status}\nCORS Headers:\n${JSON.stringify(corsHeaders, null, 2)}`, 
                    response.status === 200 ? 'success' : 'error');
            } catch (error) {
                addResult('basic-api-results', 'CORS Policy Check', `Error: ${error.message}`, 'error');
            }
        }

        async function testAPIVersions() {
            try {
                const response = await fetch('http://localhost:8000/api/versions');
                const data = await response.json();
                addResult('basic-api-results', 'API Versions', JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                addResult('basic-api-results', 'API Versions', `Error: ${error.message}`, 'error');
            }
        }

        // Chat API Tests
        async function testSimpleChatV1() {
            try {
                const response = await fetch('http://localhost:8000/api/v1/chat/simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Hello from comprehensive test v1',
                        session_id: 'test_v1_' + Date.now()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('chat-api-results', 'Simple Chat V1', `HTTP ${response.status}: ${response.statusText}\n${errorText}`, 'error');
                    return;
                }

                const result = await response.json();
                addResult('chat-api-results', 'Simple Chat V1', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                addResult('chat-api-results', 'Simple Chat V1', `Error: ${error.message}`, 'error');
            }
        }

        async function testSimpleChatDirect() {
            try {
                const response = await fetch('http://localhost:8000/api/chat/simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'Hello from comprehensive test direct',
                        session_id: 'test_direct_' + Date.now()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('chat-api-results', 'Simple Chat Direct', `HTTP ${response.status}: ${response.statusText}\n${errorText}`, 'error');
                    return;
                }

                const result = await response.json();
                addResult('chat-api-results', 'Simple Chat Direct', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                addResult('chat-api-results', 'Simple Chat Direct', `Error: ${error.message}`, 'error');
            }
        }

        async function testChatHealthEndpoint() {
            try {
                const response = await fetch('http://localhost:8000/api/v1/chat/health');
                const data = await response.json();
                addResult('chat-api-results', 'Chat Health Endpoint', JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                addResult('chat-api-results', 'Chat Health Endpoint', `Error: ${error.message}`, 'error');
            }
        }

        async function testAuthenticatedChat() {
            try {
                // First try to get auth token (this might fail if not logged in)
                const token = localStorage.getItem('auth_token') || 'test-token';
                
                const response = await fetch('http://localhost:8000/api/v1/chat/conversations', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        title: 'Test Conversation',
                        context: 'general_inquiry',
                        initial_message: 'Hello from authenticated test'
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('chat-api-results', 'Authenticated Chat', 
                        `HTTP ${response.status}: ${response.statusText}\n${errorText}\nNote: This may fail if not logged in`, 'warning');
                    return;
                }

                const result = await response.json();
                addResult('chat-api-results', 'Authenticated Chat', JSON.stringify(result, null, 2), 'success');
            } catch (error) {
                addResult('chat-api-results', 'Authenticated Chat', `Error: ${error.message}`, 'warning');
            }
        }

        // WebSocket Tests
        async function testWebSocketConnection() {
            try {
                const wsUrl = 'ws://localhost:8000/ws';
                websocket = new WebSocket(wsUrl);
                
                websocket.onopen = function(event) {
                    addResult('websocket-results', 'WebSocket Connection', 'Successfully connected to WebSocket', 'success');
                };
                
                websocket.onmessage = function(event) {
                    const message = JSON.parse(event.data);
                    addResult('websocket-results', 'WebSocket Message Received', JSON.stringify(message, null, 2), 'success');
                };
                
                websocket.onerror = function(error) {
                    addResult('websocket-results', 'WebSocket Error', `WebSocket error: ${error}`, 'error');
                };
                
                websocket.onclose = function(event) {
                    addResult('websocket-results', 'WebSocket Closed', `Connection closed: ${event.code} ${event.reason}`, 'warning');
                };
                
                // Timeout check
                setTimeout(() => {
                    if (websocket.readyState !== WebSocket.OPEN) {
                        addResult('websocket-results', 'WebSocket Timeout', 'WebSocket connection timed out', 'error');
                    }
                }, 5000);
                
            } catch (error) {
                addResult('websocket-results', 'WebSocket Connection', `Error: ${error.message}`, 'error');
            }
        }

        async function testWebSocketHeartbeat() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                addResult('websocket-results', 'WebSocket Heartbeat', 'WebSocket not connected. Connect first.', 'warning');
                return;
            }
            
            try {
                websocket.send(JSON.stringify({
                    type: 'heartbeat',
                    timestamp: new Date().toISOString()
                }));
                addResult('websocket-results', 'WebSocket Heartbeat Sent', 'Heartbeat message sent', 'success');
            } catch (error) {
                addResult('websocket-results', 'WebSocket Heartbeat', `Error: ${error.message}`, 'error');
            }
        }

        function disconnectWebSocket() {
            if (websocket) {
                websocket.close();
                websocket = null;
                addResult('websocket-results', 'WebSocket Disconnect', 'WebSocket connection closed', 'success');
            } else {
                addResult('websocket-results', 'WebSocket Disconnect', 'No WebSocket connection to close', 'warning');
            }
        }

        // LLM Tests
        async function testLLMSimpleQuery() {
            try {
                const response = await fetch('http://localhost:8000/api/chat/simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'What is cloud computing?',
                        session_id: 'llm_test_simple_' + Date.now()
                    })
                });

                const result = await response.json();
                
                if (result.response && result.response.length > 50) {
                    addResult('llm-results', 'LLM Simple Query', 
                        `Success! LLM responded with ${result.response.length} characters:\n\n"${result.response.substring(0, 200)}..."`, 'success');
                } else {
                    addResult('llm-results', 'LLM Simple Query', 
                        `Response seems too short or missing:\n${JSON.stringify(result, null, 2)}`, 'warning');
                }
            } catch (error) {
                addResult('llm-results', 'LLM Simple Query', `Error: ${error.message}`, 'error');
            }
        }

        async function testLLMComplexQuery() {
            try {
                const response = await fetch('http://localhost:8000/api/chat/simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: 'I need help designing a scalable microservices architecture on AWS for a fintech application handling 1M transactions per day with strict compliance requirements. What are the key components and best practices?',
                        session_id: 'llm_test_complex_' + Date.now()
                    })
                });

                const result = await response.json();
                
                if (result.response && result.response.length > 200) {
                    addResult('llm-results', 'LLM Complex Query', 
                        `Success! LLM provided detailed response (${result.response.length} characters):\n\n"${result.response.substring(0, 300)}..."`, 'success');
                } else {
                    addResult('llm-results', 'LLM Complex Query', 
                        `Response seems insufficient for complex query:\n${JSON.stringify(result, null, 2)}`, 'warning');
                }
            } catch (error) {
                addResult('llm-results', 'LLM Complex Query', `Error: ${error.message}`, 'error');
            }
        }

        async function testLLMErrorHandling() {
            try {
                const response = await fetch('http://localhost:8000/api/chat/simple', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: '', // Empty message to test validation
                        session_id: 'llm_test_error_' + Date.now()
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('llm-results', 'LLM Error Handling', 
                        `Good! API properly rejected empty message:\nHTTP ${response.status}: ${errorText}`, 'success');
                } else {
                    const result = await response.json();
                    addResult('llm-results', 'LLM Error Handling', 
                        `Warning: API accepted empty message:\n${JSON.stringify(result, null, 2)}`, 'warning');
                }
            } catch (error) {
                addResult('llm-results', 'LLM Error Handling', `Network error: ${error.message}`, 'error');
            }
        }

        // Frontend Integration Tests
        async function testFrontendAPIAccess() {
            try {
                // Test with typical frontend request headers
                const response = await fetch('http://localhost:8000/api/chat/simple', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3000',
                        'Referer': 'http://localhost:3000/chat'
                    },
                    body: JSON.stringify({
                        message: 'Testing frontend access',
                        session_id: 'frontend_test_' + Date.now()
                    })
                });

                const result = await response.json();
                addResult('frontend-results', 'Frontend API Access', 
                    `Success! Frontend can access API:\n${JSON.stringify(result, null, 2)}`, 'success');
            } catch (error) {
                addResult('frontend-results', 'Frontend API Access', `Error: ${error.message}`, 'error');
            }
        }

        async function testAuthToken() {
            const token = localStorage.getItem('auth_token');
            if (token) {
                addResult('frontend-results', 'Auth Token Check', 
                    `Auth token found in localStorage:\n${token.substring(0, 50)}...`, 'success');
                
                // Test token validity
                try {
                    const response = await fetch('http://localhost:8000/api/v1/auth/profile', {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        const profile = await response.json();
                        addResult('frontend-results', 'Auth Token Validity', 
                            `Token is valid! User: ${profile.full_name} (${profile.email})`, 'success');
                    } else {
                        addResult('frontend-results', 'Auth Token Validity', 
                            `Token is invalid or expired: HTTP ${response.status}`, 'warning');
                    }
                } catch (error) {
                    addResult('frontend-results', 'Auth Token Validity', 
                        `Error testing token: ${error.message}`, 'error');
                }
            } else {
                addResult('frontend-results', 'Auth Token Check', 
                    'No auth token found in localStorage. User may not be logged in.', 'warning');
            }
        }

        async function simulateFrontendChat() {
            try {
                // Simulate the exact request the frontend would make
                const API_BASE_URL = 'http://localhost:8000';
                const response = await fetch(`${API_BASE_URL}/api/chat/simple`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: 'Hello, I need help with my infrastructure assessment',
                        session_id: `simple_${Date.now()}`
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    addResult('frontend-results', 'Simulate Frontend Chat', 
                        `Failed: HTTP ${response.status}: ${response.statusText}\n${errorText}`, 'error');
                    return;
                }

                const result = await response.json();
                addResult('frontend-results', 'Simulate Frontend Chat', 
                    `Success! Chat working as frontend would use it:\n\nUser: "Hello, I need help with my infrastructure assessment"\n\nAI: "${result.response}"`, 'success');
            } catch (error) {
                addResult('frontend-results', 'Simulate Frontend Chat', `Error: ${error.message}`, 'error');
            }
        }

        // System Tests
        async function getSystemMetrics() {
            try {
                const response = await fetch('http://localhost:8000/api/v1/admin/metrics');
                const data = await response.json();
                addResult('system-results', 'System Metrics', JSON.stringify(data, null, 2), 'success');
            } catch (error) {
                addResult('system-results', 'System Metrics', `Error: ${error.message}`, 'warning');
            }
        }

        async function checkDockerServices() {
            // This would need to be implemented server-side, for now show a placeholder
            addResult('system-results', 'Docker Services', 
                'Docker services check would need server-side implementation.\n\nExpected services:\n- infra-mind-api-dev (port 8000)\n- infra-mind-frontend-dev (port 3000)\n- infra-mind-mongodb-dev (port 27017)\n- infra-mind-redis (port 6379)', 'warning');
        }

        async function runFullDiagnostic() {
            addResult('system-results', 'Full Diagnostic Started', 'Running comprehensive system diagnostic...', 'success');
            
            // Run all tests sequentially
            await testAPIHealth();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testSimpleChatDirect();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testLLMSimpleQuery();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testFrontendAPIAccess();
            await new Promise(resolve => setTimeout(resolve, 500));
            await testWebSocketConnection();
            
            addResult('system-results', 'Full Diagnostic Complete', 'All tests completed. Check results above.', 'success');
        }

        // Auto-run basic tests on page load
        window.onload = function() {
            setTimeout(() => {
                testAPIHealth();
                setTimeout(testSimpleChatDirect, 1000);
            }, 500);
        };
    </script>
</body>
</html>